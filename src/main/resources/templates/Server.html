<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Home</title>


    <script src="jquery/jquery-3.3.1.js"></script>
    <script src="bootstrap-4.1.3/js/bootstrap.js"></script>
    <script src="js/plotly.js"></script>
    <link href="bootstrap-4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="fontawesome-5.6.3/css/fontawesome.css">
    <script src="https://unpkg.com/gijgo@1.9.11/js/gijgo.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/gijgo@1.9.11/css/gijgo.min.css" rel="stylesheet" type="text/css" />


</head>
<body>
<div class="container-fluid">

        <nav class="navbar navbar-expand-md fixed-top navbar-dark bg-dark">
            <div class="navbar-collapse collapse w-100 order-1 order-md-0 dual-collapse2">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/index}">Home</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" th:href="@{/server}">Server</a>
                    </li>
                    <div id="temperatureNavBar"></div>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                </ul>
            </div>
            <div class="mx-auto order-0">
                <a class="navbar-brand mx-auto">
                    <img src="/image/home_logo.png" width="100" height="50" alt="logo">
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".dual-collapse2">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="navbar-collapse collapse w-100 order-3 dual-collapse2">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Right</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                </ul>
            </div>
        </nav>



        <div class="row">

            <div class="col-md-5 offset-md-1">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center"> Platform information</h3>
                    </div>
                    <div class="card-body pre-scrollable">
                        <div class="scrollbar">
                            <div class="force-overflow">
                                <div id="server_platformName"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center"> Memory Information</h3>
                    </div>
                    <div class="card-body pre-scrollable">
                        <div class="scrollbar">
                            <div class="force-overflow">
                                <div class="mx-auto" id="server_memoryInfo"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="row my-3">

            <div class="col-md-6 offset-md-3">
                <div class="card mx-2">
                    <div class="card-header">
                        <h3 class="text-center"> Cooling fan</h3>
                    </div>
                    <div class="card-body mt-2">
                        <div id="serverFan_running"></div>
                        <div id="serverFan_setpoint"></div>
                        <div id="serverFan_cpuTemp"></div>
                            <form  id="serverFan_setpoint_update" class="text-center" action="" method="">
                                <div id="serverFan_setpoint_update_text"></div>
                                <input id="serverFan_setpoint_update_value" type="text" class="mb-1" placeholder="Setpoint value....">
                                <input type="submit" class="btn btn-primary mb-1" value="Update" />
                            </form>
                    </div>
                </div>
            </div>
        </div>



    <!-- Temperature devices, Modal window -->
    <div class="modal fade" id="temperatureModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title mx-auto" id="temperatureModalTitle"></div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                </div>
                <div class="row" id="tt_latest_values"></div>
                <div id="temperaturModal_Graph_Window" style="max-height:100%" class="modal-body">
                        <div id="tt_datepicker" class="row">
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div width="100%" height="500" id="temperaturModal_Graph"></div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div> <!-- Temperature devices, Modal window -->

</div> <!-- Container -->


<!-- Javascript for Temperature devices -->
<script>

function temperaturDevice(name,deviceId){
    $('#temperatureModalTitle').empty();
    $('#temperatureModalTitle').append("<h2> Temperature - " + name + "</h2>");
    //$('#temperatureModalTitle').append("<h5> ID: " + deviceId + "</h5>");
    $('#temperatureModal').modal('show')

    TT_Data_min_max(deviceId);

}

function TT_Data_min_max(deviceId){
    	var formData = {
    		uid : deviceId,
    	}
    	$.ajax({
			type : "POST",
			contentType : "application/json",
			url : "/TT/date/minmax",
			data : JSON.stringify(formData),
			success : function(result) {
			    $('#tt_datepicker').empty();

               $('#tt_datepicker').append("<div class=\"col-4\"><label for=\"tt_datepicker_from\">From:</label><input class=\"w-75 mx-auto\" id=\"tt_datepicker_from\" /></div>");

               $('#tt_datepicker_from').datepicker({
                    format: 'yyyy-mm-dd',
                    value: String(result[1]),
                    minDate: String(result[0]),
                    maxDate: String(result[1]),
                    uiLibrary: 'bootstrap4'
                });

                $('#tt_datepicker_from').change(function() {
                    /* Check if the date in from is above to. If this is the case, set the 'to' date same as 'from'. */
                        var from_date = new Date($('#tt_datepicker_from').val());
                        var to_date = new Date($('#tt_datepicker_to').val());
                     if( from_date.getTime() > to_date.getTime() ){
                        $('#tt_datepicker_to').val(String($('#tt_datepicker_from').val()));
                     }
                });


                var tt2 = "<div class=\"col-4\"><label for=\"tt_datepicker_to\">To:</label> <input class=\"w-75 mx-auto\" id=\"tt_datepicker_to\" /></div>"
               $('#tt_datepicker').append(tt2);

               $('#tt_datepicker_to').datepicker({
                    format: 'yyyy-mm-dd',
                    value: String(result[1]),
                    minDate: String(result[0]),
                    maxDate: String(result[1]),
                    uiLibrary: 'bootstrap4'
                });

                $('#tt_datepicker_to').change(function() {
                     /* Check if the date in 'to' is less than 'from'. If this is the case, set the 'from' date same as 'to'. */
                        var from_date = new Date($('#tt_datepicker_from').val());
                        var to_date = new Date($('#tt_datepicker_to').val());
                     if( to_date.getTime() < from_date.getTime() ){
                        $('#tt_datepicker_from').val(String($('#tt_datepicker_to').val()));
                     }
                });

                var tt_btn = "<div class=\"col-4 text-center my-auto\"><button onclick=\TT_Data(" + deviceId + ") type=\"button\" class=\"btn btn-primary w-75\">Update</button></div>"
               $('#tt_datepicker').append(tt_btn);

               TT_Data_Latest(deviceId);
               TT_Data(deviceId);

			},
			error : function(e) {

			}
		});
}; <!-- function TT_Data_min_max -->



function TT_Data(deviceId){
    	var formData = {
    		uid : deviceId,
    		dateFrom : String($('#tt_datepicker_from').val()),
    		dateTo: String($('#tt_datepicker_to').val()),
    	}

    	$.ajax({
			type : "POST",
			contentType : "application/json",
			url : "/TT/data",
			data : JSON.stringify(formData),
			success : function(result) {


                 var time = [];
			     var pressure = [];
			     var temperature = [];
			     var humidity = [];
			     var voltage = [];
			     for(var i = 0; i < result.length; i++){
                    var obj = JSON.parse(result[i]);
                    pressure[i] = obj.pressure;
                    temperature[i] = obj.temperature;
                    humidity[i] = obj.humidity;
                    voltage[i] = obj.voltage;
                    time[i] = obj.timestamp.substring(0,obj.timestamp.length - 2);
                }
                var trace_pressure = {
                  x: time,
                  y: pressure,
                  name: 'Pressure (hPa)',
                  type: 'scatter'
                };
                var trace_temperature = {
                  x: time,
                  y: temperature,
                  name: 'Temperature (°C)',
                  type: 'scatter'
                };
                var trace_humidity = {
                  x: time,
                  y: humidity,
                  name: 'Humidity (%)',
                  type: 'scatter'
                };
                 var trace_voltage = {
                  x: time,
                  y: voltage,
                  name: 'Voltage (VDC)',
                  type: 'scatter'
                };
                var data = [trace_pressure, trace_temperature, trace_humidity, trace_voltage];
                // Height and width for mobile devices.
                var height;
                var width;
                if(window.innerWidth < 768){
                 width = 0.8 * $('#temperatureModal').width();
                 height = 0.8 * $('#temperaturModal_Graph_Window').height();
                }
                else{
                 width = 1 * $('#temperaturModal_Graph_Window').width();
                 height = 0.85 * $('#temperaturModal_Graph_Window').height();
                }
                var layout = {
                 width: width,
                 height: height,
                showlegend: true,
                 legend: {"orientation": "h", x: 0, y: 1.2}
                };

                if(result.length === 0){
                     $('#temperaturModal_Graph').empty();
                     $('#temperaturModal_Graph').html("<img src=\"image/nodatafound.png\" class=\"img-fluid mx-auto d-block\" >");
                }
                else{
                 $('#temperaturModal_Graph').empty();
                    var myDiv = document.getElementById('temperaturModal_Graph')
                    Plotly.newPlot(myDiv, data, layout);
                    window.onresize = function() {
                      Plotly.relayout(myDiv, {
                        width: 1 * $('#temperaturModal_Graph_Window').width(),
                        height: 0.85 * $('#temperaturModal_Graph_Window').height()
                      })
                    }
                  }

			},
			error : function(e) {
			console.log(e);
	            $("#temperaturModal_Graph").html(e.responseText);
			}
		});
}; <!-- function TT_Data -->

function TT_Data_Latest(deviceId){
    	var formData = {
    		uid : deviceId,
    	}

    	$.ajax({
			type : "POST",
			contentType : "application/json",
			url : "/TT/data/latest",
			data : JSON.stringify(formData),
			success : function(result) {
                if(result == 0){
                $('#tt_latest_values').empty();
                }
                else{
                var obj = JSON.parse(result);
                $('#tt_latest_values').empty();
                if(obj.online){
                    var values = "<h5 style=\"color:green\"" + "data-toggle=\"tooltip\" data-placement=\"top\"" +
                    "title=\"" + obj.timestamp +"\">" + obj.temperature + "°C " +
                    + obj.pressure + "hPa " +  obj.humidity + "% " + obj.voltage + "VDC " + "</h5>";
                    $('#temperatureModalTitle').append(values);
                 }
                 else{
                    var values = "<h5 style=\"color:red\"" + "data-toggle=\"tooltip\" data-placement=\"top\"" +
                    "title=\"" + obj.timestamp +"\">" + obj.temperature + "°C " +
                    + obj.pressure + "hPa " +  obj.humidity + "% " + obj.voltage + "VDC " + " (Device is offline)</h5>";
                    $('#temperatureModalTitle').append(values);

                 }
                }

			},
			error : function(e) {
			console.log(e);
	            $("#tt_latest_values").html(e.responseText);
			}
		});
}; <!-- function TT_Data_Latest -->



$(document).ready(function(){
       	    temperature_navbar();
       	});
function temperature_navbar(){
	$.ajax({
		url: "/navbar/temperature/devices",
		method: "GET",
		success: function(data) {
		    $('#temperatureNavBar').html(data);
		},
		error: function(data) {
			console.log(data);
		}
	});
};

</script> <!-- Javascript for Temperature devices -->


<script>
	$(document).ready(function(){
       	    Version_Text();
       	    getCPUInformation();
       	    getStorage();
       	});

	function Version_Text(){
	$.ajax({
		url: "/version",
		method: "GET",
		success: function(data) {
		    $('#version').empty();
		    $('#version').html(data);
		},
		error: function(data) {
			console.log(data);
			$('#version').empty();
		    $('#version').html(data);
		}
	});
};

function getCPUInformation(){
	$.ajax({
		url: "/server/cpuinformation",
		method: "GET",
		success: function(data) {
		    $('#server_platformName').empty();
		    var sData;
		    for(var i = 0; i < data.length; i++){
                if(i > 1){
                sData = sData + "<p>" + data[i] + "</p>";
                }
                else{
                sData = "<p>" + data[i] + "</p>";
                }
		    }
		    $('#server_platformName').html(sData);
		},
		error: function(data) {
			$('#server_platformName').empty();
		    var sData;
            for(var i = 0; i < data.length; i++){
                 if(i > 1){
                 sData = sData + "<p class=\"text-center text-danger\">" + data[i] + "</p>";
                 }
                 else{
                  sData = "<p class=\"text-center text-danger\">" + data[i] + "</p>";
                 }
            }
             $('#server_platformName').html(sData);
		}
	});
};

function getStorage(){
	$.ajax({
		url: "/server/storage",
		method: "GET",
		success: function(data) {
		    $('#server_memoryInfo').empty();

		    var filePlace = [];
		    var oneMBlocks = [];
		    var used = [];
		    var available = [];
		    var usePercentage = [];
		    var mountedOn = [];
		    for(var i = 1; i < data.length; i++){
		    var dataSplit = data[i].split(",");
		     filePlace.push(dataSplit[0]);
             oneMBlocks.push(dataSplit[1]);
             used.push(dataSplit[2]);
             available.push(dataSplit[3]);
             usePercentage.push(dataSplit[4]);
             mountedOn.push(dataSplit[5]);
		    }
            var tableValues = [
                          filePlace,
                          oneMBlocks,
                          used,
                          available,
                          usePercentage,
                          mountedOn]

                    var tableData = [{
                      type: 'table',
                      header: {
                        values: [
                        ["Filesystem"],
                        ["1M-blocks"],
                        ["Used"],
                        ["Available"],
                        ["Use(%)"],
                        ["Monted On"]
                        ],
                        align: "center",
                        line: {width: 1, color: 'black'},
                        fill: {color: "grey"},
                        font: {family: "Arial", size: 12, color: "white"}
                      },
                      cells: {
                        values: tableValues,
                        align: "center",
                        line: {color: "black", width: 1},
                        font: {family: "Arial", size: 11, color: ["black"]}
                      }
                    }]
                    Plotly.plot('server_memoryInfo', tableData, {}, {showSendToCloud: true});


		},
		error: function(data) {
			$('#server_memoryInfo').empty();
		    var sData;
            for(var i = 0; i < data.length; i++){
                 if(i > 1){
                 sData = sData + "<p class=\"text-center text-danger\">" + data[i] + "</p>";
                 }
                 else{
                  sData = "<p class=\"text-center text-danger\">" + data[i] + "</p>";
                 }
            }
             $('#server_memoryInfo').html(sData);
		}
	});
};




	$(document).ready(function(){
	   getServerFanRunning();
	   setInterval(getServerFanRunning, 1000);
	});

	function getServerFanRunning(){
	$.ajax({
		url: "/serverFan/output",
		method: "GET",
		success: function(data) {
		    $('#serverFan_running').empty();
		    if(data == "true"){
		    $('#serverFan_running').empty();
		    $('#serverFan_running').html("<img src=\"/image/fan_icon_on.png\" class=\"img-responsive mx-auto d-block\">");
		    }
		    else{
		    $('#serverFan_running').empty();
		    $('#serverFan_running').html("<img src=\"/image/fan_icon_off.png\" class=\"img-responsive mx-auto d-block\">");
		    }

		},
		error: function(e) {
			$('#serverFan_running').empty();
		    $('#serverFan_running').html(e.responseText);
		}
	});
};



	$(document).ready(function(){
	   getServerCPUTemp();
	   setInterval(getServerCPUTemp, 1000);
	});
	function getServerCPUTemp(){
     $.ajax({
     url: "/server/cputemperature",
     method: "GET",
     success: function(data) {
     $('#serverFan_cpuTemp').empty();
     $('#serverFan_cpuTemp').html("<h4 class=\"text-center\"> CPU temperature: " + data + " °C</h4>");
     },
     error: function(e) {
     $('#serverFan_cpuTemp').empty();
     $('#serverFan_cpuTemp').html(e.responseText);
     }
     });
     };



	$(document).ready(function(){
	   getServerFanSetpoint();
	});

	function getServerFanSetpoint(){
	$.ajax({
		url: "/serverFan/setpoint",
		method: "GET",
		success: function(data) {
		    $('#serverFan_setpoint').empty();
		    $('#serverFan_setpoint').html("<h4 class=\"text-center\"> Setpoint: " + data + " °C</h4>");
		},
		error: function(data) {
			console.log(data);
			$('#serverFan_setpoint').empty();
		    $('#serverFan_setpoint').html(data);
		}
	});
};



$( document ).ready(function() {

	// SUBMIT FORM
    $("#serverFan_setpoint_update").submit(function(event) {
		// Prevent the form from submitting via the browser.
		event.preventDefault();
		setServerFanSetpoint();
	});


    function setServerFanSetpoint(){
    	var formData = {
    		setpoint : $("#serverFan_setpoint_update_value").val(),
    	}
    	$.ajax({
			type : "POST",
			contentType : "application/json",
			url : "/serverfan/updateSetpoint",
			data : JSON.stringify(formData),
			success : function(result) {
				$("#serverFan_setpoint_update_text").html(result);
				getServerFanSetpoint();
			},
			error : function(e) {
			console.log(e);
	            $("#serverFan_setpoint_update_text").html(e.responseText);
			}
		});
    }
})






</script>



</body>
</html>
